<% content_for :title, t("exports.title") %>

<div class="export-page">
  <div class="page-header">
    <h1><%= t("exports.title") %></h1>
    <p class="page-description"><%= t("exports.description") %></p>
  </div>

  <div class="export-form-container">
    <%= form_with model: @export_service, url: exports_path, local: true, class: "export-form" do |form| %>
      <% if @export_service.errors.any? %>
        <div class="alert alert-danger">
          <h4><%= t("exports.errors.title") %></h4>
          <ul>
            <% @export_service.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="form-section">
        <h3><%= t("exports.data_type") %></h3>
        <div class="form-group">
          <%= form.select :export_type, 
                         options_for_select([
                           [t("exports.types.responses"), "responses"],
                           [t("exports.types.forms"), "forms"],
                           [t("exports.types.users"), "users"],
                           [t("exports.types.reports"), "reports"]
                         ], @export_service.export_type),
                         { prompt: t("exports.select_data_type") },
                         class: "form-control" %>
        </div>
      </div>

      <div class="form-section">
        <h3><%= t("exports.format") %></h3>
        <div class="form-group">
          <%= form.select :format, 
                         options_for_select([
                           [t("exports.formats.csv"), "csv"],
                           [t("exports.formats.excel"), "excel"],
                           [t("exports.formats.pdf"), "pdf"],
                           [t("exports.formats.json"), "json"],
                           [t("exports.formats.xml"), "xml"]
                         ], @export_service.format),
                         { prompt: t("exports.select_format") },
                         class: "form-control" %>
        </div>
      </div>

      <div class="form-section" id="filters-section" style="display: none;">
        <h3><%= t("exports.filters") %></h3>
        
        <div class="filter-group">
          <h4><%= t("exports.date_range") %></h4>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <%= label_tag "data_export_service_filters_date_from", t("exports.from_date") %>
                <%= date_field_tag "data_export_service[filters][date_from]", 
                                   @export_service.filters[:date_from],
                                   class: "form-control" %>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <%= label_tag "data_export_service_filters_date_to", t("exports.to_date") %>
                <%= date_field_tag "data_export_service[filters][date_to]", 
                                   @export_service.filters[:date_to],
                                   class: "form-control" %>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group" id="form-filters" style="display: none;">
          <h4><%= t("exports.forms") %></h4>
          <div class="form-group">
            <%= select_tag "data_export_service[filters][form_ids][]",
                           options_from_collection_for_select(@forms, :id, :name, @export_service.filters[:form_ids]),
                           { multiple: true, class: "form-control" } %>
          </div>
        </div>

        <div class="filter-group" id="user-filters" style="display: none;">
          <h4><%= t("exports.users") %></h4>
          <div class="form-group">
            <%= select_tag "data_export_service[filters][user_ids][]",
                           options_from_collection_for_select(@users, :id, :name, @export_service.filters[:user_ids]),
                           { multiple: true, class: "form-control" } %>
          </div>
        </div>

        <div class="filter-group" id="source-filters" style="display: none;">
          <h4><%= t("exports.sources") %></h4>
          <div class="form-group">
            <%= select_tag "data_export_service[filters][sources][]",
                           options_for_select([
                             [t("exports.sources.web"), "web"],
                             [t("exports.sources.odk"), "odk"],
                             [t("exports.sources.sms"), "sms"]
                           ], @export_service.filters[:sources]),
                           { multiple: true, class: "form-control" } %>
          </div>
        </div>

        <div class="filter-group" id="status-filters" style="display: none;">
          <h4><%= t("exports.status") %></h4>
          <div class="form-group">
            <%= select_tag "data_export_service[filters][incomplete]",
                           options_for_select([
                             [t("exports.all"), ""],
                             [t("exports.complete_only"), "false"],
                             [t("exports.incomplete_only"), "true"]
                           ], @export_service.filters[:incomplete]),
                           { class: "form-control" } %>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-group">
          <div class="checkbox">
            <%= form.check_box :include_media, class: "form-check-input" %>
            <%= form.label :include_media, t("exports.include_media"), class: "form-check-label" %>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <%= form.submit t("exports.export_data"), class: "btn btn-primary btn-lg" %>
        <%= link_to t("exports.cancel"), dashboard_path, class: "btn btn-secondary btn-lg" %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const exportTypeSelect = document.querySelector('select[name="data_export_service[export_type]"]');
  const filtersSection = document.getElementById('filters-section');
  const formFilters = document.getElementById('form-filters');
  const userFilters = document.getElementById('user-filters');
  const sourceFilters = document.getElementById('source-filters');
  const statusFilters = document.getElementById('status-filters');

  function toggleFilters() {
    const exportType = exportTypeSelect.value;
    
    if (exportType === 'responses') {
      filtersSection.style.display = 'block';
      formFilters.style.display = 'block';
      userFilters.style.display = 'block';
      sourceFilters.style.display = 'block';
      statusFilters.style.display = 'block';
    } else if (exportType === 'forms') {
      filtersSection.style.display = 'block';
      formFilters.style.display = 'none';
      userFilters.style.display = 'none';
      sourceFilters.style.display = 'none';
      statusFilters.style.display = 'none';
    } else if (exportType === 'users') {
      filtersSection.style.display = 'block';
      formFilters.style.display = 'none';
      userFilters.style.display = 'block';
      sourceFilters.style.display = 'none';
      statusFilters.style.display = 'none';
    } else if (exportType === 'reports') {
      filtersSection.style.display = 'block';
      formFilters.style.display = 'none';
      userFilters.style.display = 'none';
      sourceFilters.style.display = 'none';
      statusFilters.style.display = 'none';
    } else {
      filtersSection.style.display = 'none';
    }
  }

  exportTypeSelect.addEventListener('change', toggleFilters);
  
  // Initialize on page load
  toggleFilters();
});
</script>

<style>
.export-page {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.page-header {
  margin-bottom: 30px;
  text-align: center;
}

.page-description {
  color: #666;
  font-size: 1.1em;
}

.export-form-container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 30px;
}

.form-section {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.form-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.form-section h3 {
  color: #333;
  margin-bottom: 15px;
  font-size: 1.3em;
}

.filter-group {
  margin-bottom: 20px;
}

.filter-group h4 {
  color: #555;
  margin-bottom: 10px;
  font-size: 1.1em;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  font-weight: 500;
  color: #333;
  margin-bottom: 5px;
  display: block;
}

.form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.form-control:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-check-input {
  margin: 0;
}

.form-actions {
  text-align: center;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

.btn {
  padding: 12px 24px;
  margin: 0 10px;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  cursor: pointer;
  text-decoration: none;
  display: inline-block;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-primary:hover {
  background: #0056b3;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #545b62;
}

.alert {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
}

.alert-danger {
  color: #721c24;
  background-color: #f8d7da;
  border-color: #f5c6cb;
}

.alert h4 {
  margin-top: 0;
  margin-bottom: 10px;
}

.alert ul {
  margin-bottom: 0;
}

@media (max-width: 768px) {
  .export-page {
    padding: 10px;
  }
  
  .export-form-container {
    padding: 20px;
  }
  
  .form-actions {
    text-align: center;
  }
  
  .btn {
    display: block;
    width: 100%;
    margin: 10px 0;
  }
}
</style>